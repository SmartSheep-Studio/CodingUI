<template>
  <div style="width: 100%">
    <n-grid :x-gap="16" :y-gap="16">
      <n-gi :span="15">
        <n-card style="height: 100%" title="Âü∫Êú¨Êï∞ÊçÆ">
          <template #header-extra>
            <n-button
              :disabled="new Date(store.profile.user['last_signin_at']).toDateString() === new Date().toDateString()"
              type="primary"
              @click="dailySignin.display = !dailySignin.display"
            >
              ÊØèÊó•Á≠æÂà∞
            </n-button>
          </template>
          <n-grid :y-gap="16">
            <!-- Currencies -->
            <n-gi :span="8">
              <n-statistic label="Ê∫ê‰ª£Á†Å" tabular-nums>
                <n-number-animation :from="0" :to="backpack.data.SourceCodes" />
                <template #prefix>
                  <n-icon>
                    <CodeSandboxCircleFilled />
                  </n-icon>
                </template>
              </n-statistic>
            </n-gi>
            <n-gi :span="8">
              <n-statistic label="Êé®ËçêÁ¨¶Êñá" tabular-nums>
                <n-number-animation :from="0" :to="backpack.data.FavouriteRunes" />
                <template #prefix>
                  <n-icon>
                    <LikeFilled />
                  </n-icon>
                </template>
              </n-statistic>
            </n-gi>
            <n-gi :span="8">
              <n-statistic label="ÈÄªËæëÂ∏Å" tabular-nums>
                <n-number-animation :from="0" :to="backpack.data.CodeCoins" />
                <template #prefix>
                  <n-icon>
                    <DollarCircleFilled />
                  </n-icon>
                </template>
              </n-statistic>
            </n-gi>

            <!-- Player States -->
            <n-gi :span="8">
              <n-statistic label="ÁêÜÊô∫" tabular-nums>
                <n-number-animation :from="0" :to="backpack.data.Rational" />
                <template #prefix>
                  <n-icon>
                    <BulbFilled />
                  </n-icon>
                </template>
                <template #suffix> / {{ 86 + (store.profile.user["level"] - 1) * 2 }}</template>
              </n-statistic>
            </n-gi>
            <n-gi :span="8">
              <n-statistic label="ËÉΩÈáè" tabular-nums>
                <n-number-animation :from="0" :to="backpack.data.Energy" />
                <template #prefix>
                  <n-icon>
                    <PowerSharp />
                  </n-icon>
                </template>
                <template #suffix> / {{ 20 + (store.profile.user["level"] - 1) * 8 }}</template>
              </n-statistic>
            </n-gi>
            <n-gi :span="8">
              <n-statistic label="ÂàÜ‰∫´‰ª§Áâå" tabular-nums>
                <n-number-animation :from="0" :to="backpack.data.ShareTicket" />
                <template #prefix>
                  <n-icon>
                    <TicketSharp />
                  </n-icon>
                </template>
                <template #suffix> / {{ 10 + (store.profile.user["level"] - 1) }}</template>
              </n-statistic>
            </n-gi>

            <!-- Statistics -->
            <n-gi :span="24">
              <div id="statistics-chart" style="height: 310px; width: 100%; margin-top: 15px"></div>
            </n-gi>
          </n-grid>
        </n-card>
      </n-gi>
      <n-gi :span="9">
        <n-card embedded style="height: 100%" title="Á•ûÁªèËÆ∞ÂøÜ">
          <n-card>
            <n-grid>
              <n-gi :span="9">
                <n-progress
                  :percentage="
                    (store.profile.user['level_experience'] /
                      UpgradeRequireCompute(
                        store.profile.user['level'],
                        store.node.details['Level']['Requirement'],
                        store.node.details['Level']['Difficulty']
                      )) *
                    100
                  "
                  size="large"
                  type="circle"
                >
                  <div style="text-align: center">
                    <div style="font-size: 20px">
                      Lv <b>{{ store.profile.user["level"] }}</b>
                    </div>
                    <span style="font-size: 14px">Êó†Â∞ΩÊ∑±Ê∏ä</span>
                  </div>
                </n-progress>
              </n-gi>
              <n-gi :offset="2" :span="13">
                <div style="padding-top: 10px">
                  <n-avatar></n-avatar>
                  <div style="font-size: 20px">
                    <b style="line-height: 34px">Dr. {{ store.profile.user["username"] }}</b>
                  </div>
                  <div>
                    <span
                      ><b>ÁªèÈ™å</b>
                      {{ SimpleNumber(store.profile.user["level_experience"]) }}
                      /
                      {{
                        SimpleNumber(
                          UpgradeRequireCompute(
                            store.profile.user["level"],
                            store.node.details["Level"]["Requirement"],
                            store.node.details["Level"]["Difficulty"]
                          )
                        )
                      }}</span
                    >
                    <br />
                    <span>
                      <b>ËäÇÁÇπ</b> <span>{{ store.node.name }}</span>
                    </span>
                    <br />
                    <span
                      ><b>ÂõûÂøÜËµ∑ÁÇπ&nbsp;</b>
                      <span>{{ new Date(store.profile.user["created_at"]).toLocaleDateString() }}</span></span
                    >
                  </div>
                </div>
              </n-gi>
            </n-grid>
          </n-card>
          <n-card style="margin-top: 16px">
            <span
              >ËµõÂ≠£ <b>Ëµ∑Ê∫ê</b> Â∞Ü‰ºöÂú®
              <b><n-countdown :duration="30 * 3600 * 1000" active /></b>
              ÁªìÊùü</span
            >
            <br />
            <ol>
              <span style="font-size: 14px"><b>‰Ω†ÂèØ‰ª•ÂæóÂà∞ÁõÆÂâçÁöÑÂ•ñÂä±</b></span>
              <li>Á†ÅÂå†Â≤õÊ®°Âûã</li>
              <li>Ê∫ê‰ª£Á†Å x100</li>
              <li>ÈÄªËæëÂ∏Å x80,000</li>
            </ol>
          </n-card>

          <!-- Actions -->
          <n-grid :y-gap="8" style="padding-top: 12px">
            <n-gi :span="24">
              <n-button disabled style="width: 100%">
                <template #icon>
                  <n-icon>
                    <DatabaseFilled />
                  </n-icon>
                </template>
                Âü∫Á°ÄÂª∫ËÆæ
              </n-button>
            </n-gi>
            <n-gi :span="24">
              <n-button style="width: 100%" @click="$router.push({ name: 'Operation.Orders' })">
                <template #icon>
                  <n-icon>
                    <LayoutFilled />
                  </n-icon>
                </template>
                ÈÄªËæëË°åÂä®
              </n-button>
            </n-gi>
            <n-gi :span="24">
              <n-button disabled style="width: 100%">
                <template #icon>
                  <n-icon>
                    <FireFilled />
                  </n-icon>
                </template>
                Êµ∑Âè£Á†ÅÂ§¥
              </n-button>
            </n-gi>
          </n-grid>
        </n-card>
      </n-gi>
      <n-gi :span="15">
        <n-card style="height: 100%" title="Ê¥ªÂä®ËÆ∞ÂΩï">
          <n-timeline>
            <template
              v-for="(item, index) in activities.data.slice(
                (activities.page - 1) * 10,
                (activities.page - 1) * 10 + 10
              )"
              :key="index"
            >
              <n-timeline-item
                v-if="item['type'] === 'daily-signin'"
                :time="new Date(item['created_at']).toLocaleString()"
                title="ÊØèÊó•Á≠æÂà∞"
                type="success"
              />
              <n-timeline-item
                v-if="item['type'] === 'signin'"
                :content="'Â∞ùËØïËøûÊé•‰∫é ' + item['data']['at']"
                :time="new Date(item['created_at']).toLocaleString()"
                title="ÈìæÊé•Á•ûÁªèË∫´‰ªΩ"
                type="info"
              />
            </template>
          </n-timeline>
          <n-divider></n-divider>
          <n-space justify="center">
            <n-pagination v-model:page="activities.page" :page-count="Math.ceil(activities.data.length / 10)" />
          </n-space>
        </n-card>
      </n-gi>
      <n-gi :span="9">
        <n-card embedded title="ËäÇÁÇπÈÄöÂëä">
          <n-card>
            <n-collapse>
              <n-collapse-item
                v-for="(item, index) in activities.announcements"
                :key="index"
                :name="item['data']['id']"
                :title="item['data']['title']"
              >
                <template #header-extra>
                  <span v-if="item['type'] === 'update'">üìÜ</span>
                </template>
                <div v-html="item['data']['content']"></div>
              </n-collapse-item>
            </n-collapse>
          </n-card>
        </n-card>
      </n-gi>
    </n-grid>

    <!-- Modals -->
    <n-modal v-model:show="dailySignin.display" preset="card" style="max-width: 540px" title="Á≠æÂà∞ÊÅ¢Â§ç">
      <template #header-extra>
        {{ new Date().toLocaleDateString() }}
      </template>
      <div v-if="dailySignin.rewards == null">
        <span>Êõ¥ÂÖ∑ÊÇ®ÁõÆÂâçÁöÑÁ•ûÁªèËÆ∞ÂøÜÊ°£Ê°àÔºåÊÇ®ÁöÑËøôÊ¨°Á≠æÂà∞ÁöÑÂ•ñÂä±‰∏∫Ôºö</span> <br />
        <ol>
          <li>ÈÄªËæëÂ∏Å 0 ~ {{ store.profile.user["level"] * 10 + 200 }}</li>
          <li>ÁêÜÊô∫ {{ 86 + (store.profile.user["level"] - 1) * 2 }}</li>
          <li>ËÉΩÈáè {{ 20 + (store.profile.user["level"] - 1) * 8 }}</li>
          <li>ÂàÜ‰∫´‰ª§Áâå {{ 10 + store.profile.user["level"] - 1 }}</li>
          <li>ÁªèÈ™å 1800</li>
        </ol>
        <span
          ><b>Ê∏©È¶®ÊèêÁ§∫</b> Ëã•ÊòØ‰ΩøÁî®‰∫ÜÂ§ñÁΩÆÁîµÊ∫êÊàñÈùôËÑâÊ≥®Â∞ÑÁêÜÊô∫Á≠âÊÅ¢Â§çÂ±ûÊÄßÁ±ªËçØÁâ©ÔºåÂú®Á≠æÂà∞ÊÅ¢Â§çÂÆåÊàêÂêéÊ∫¢Âá∫ÁöÑÊïàÊûúÂ∞Ü‰∏çÂ§çÂ≠òÂú®</span
        >
      </div>
      <div v-else>
        <span>Á≠æÂà∞ÂÆåÊàê d(^_^o)ÔºåÊú¨Ê¨°Á≠æÂà∞Ëé∑ÂæóÂ•ñÂä±Ôºö</span>
        <ol>
          <li>ÈÄªËæëÂ∏Å {{ dailySignin.rewards["CodeCoin"] }}</li>
          <li>ÁêÜÊô∫ {{ dailySignin.rewards["Rational"] }}</li>
          <li>ËÉΩÈáè {{ dailySignin.rewards["Energy"] }}</li>
          <li>ÂàÜ‰∫´‰ª§Áâå {{ dailySignin.rewards["ShareTicket"] }}</li>
          <li>ÁªèÈ™å {{ dailySignin.rewards["Experience"] }}</li>
        </ol>
        <span
          >‰∏ãÊ¨°Á≠æÂà∞ÂºÄÊîæÊó∂Èó¥Âú® <b>{{ new Date(new Date().setHours(24, 0, 0, 0)).toLocaleString() }}</b></span
        >
      </div>
      <template #footer>
        <n-space v-if="dailySignin.rewards == null" justify="end">
          <n-button :loading="dailySignin.connecting" size="small" type="primary" @click="dailySignin.do()"
            >Á´ãÂç≥Á≠æÂà∞
          </n-button>
        </n-space>
        <n-space v-else justify="end">
          <n-button size="small" type="primary" @click="dailySignin.display = !dailySignin.display">Á≠æÂà∞ÊàêÂäü </n-button>
        </n-space>
      </template>
    </n-modal>
  </div>
</template>

<script lang="ts" setup>
import {
  NGrid,
  NGi,
  NCard,
  NStatistic,
  NNumberAnimation,
  NIcon,
  NButton,
  NProgress,
  NCollapse,
  NCollapseItem,
  NCountdown,
  NTimeline,
  NTimelineItem,
  NAvatar,
  NModal,
  NSpace,
  NPagination,
  NDivider,
  NA,
  useMessage,
} from "naive-ui";
import {
  CodeSandboxCircleFilled,
  LikeFilled,
  DollarCircleFilled,
  BulbFilled,
  DatabaseFilled,
  LayoutFilled,
  FireFilled,
} from "@vicons/antd";
import { TicketSharp } from "@vicons/ionicons5";
import { PowerSharp } from "@vicons/material";
import * as echarts from "echarts";
import { inject, onMounted, reactive, ref, watch } from "vue";
import { useStatusStore } from "../../stores/status";
import SimpleNumber from "../../utils/SimpleNumber";
import UpgradeRequireCompute from "../../utils/UpgradeRequireCompute";
import { Axios, AxiosResponse } from "axios";
import { VueCookies } from "vue-cookies";

const cookies = inject("$cookies") as VueCookies;
const axios = inject("axios") as Axios;
const message = useMessage();
const store = useStatusStore();
const backpack: any = reactive({
  data: {},
  init() {
    backpack.data = {
      SourceCodes: store.getMaterial("source-code").amount,
      FavouriteRunes: store.getMaterial("favourite-rune").amount,
      CodeCoins: store.getMaterial("code-coin").amount,
      Rational: store.getMaterial("rational").amount,
      Energy: store.getMaterial("energy").amount,
      ShareTicket: store.getMaterial("share-ticket").amount,
    };
  },
});

const dailySignin = reactive({
  display: false,
  connecting: false,
  rewards: null,
  do: async () => {
    dailySignin.connecting = true;
    let response: AxiosResponse;
    // Do Daily SignIn
    response = await axios.patch(
      "/api/security/users/daily-signin",
      {},
      {
        headers: { Authorization: "Bearer " + cookies.get("access_token") },
      }
    );
    if (response.status === 200) {
      dailySignin.rewards = response.data["Response"];
    } else {
      message.error("Êó†Ê≥ïËøõË°åÁ•ûÁªèÁ≠æÂà∞ÔºåÊú™Áü•ÈÄö‰ø°ÈîôËØØ");
      dailySignin.connecting = false;
      return;
    }
    // Update profile
    response = await axios.get("/api/security/users/profile?detail=yes", {
      headers: { Authorization: "Bearer " + cookies.get("access_token") },
    });
    const profile = response.data["Response"];
    store.setUserProfile(profile["User"], profile["Group"], profile["Backpack"]);
    dailySignin.connecting = false;
  },
});

watch(
  store.profile,
  () => {
    backpack.init();
  },
  { immediate: true, deep: true }
);

const activities = reactive({
  data: [],
  announcements: [],
  page: 1,
  fetch: async () => {
    let response: AxiosResponse;
    response = await axios.get("/api/records/announcements", {
      headers: { Authorization: "Bearer " + cookies.get("access_token") },
    });
    if (response.status != 200) {
      message.error("Êó†Ê≥ïËé∑ÂèñÁ•ûÁªèËäÇÁÇπÈÄöÂëä");
    } else {
      activities.announcements = response.data["Response"];
    }

    response = await axios.get("/api/records/activities", {
      headers: { Authorization: "Bearer " + cookies.get("access_token") },
    });
    if (response.status != 200) {
      message.error("Êó†Ê≥ïËé∑ÂèñÁ•ûÁªèËÆ∞ÂøÜÊ¥ªÂä®ËÆ∞ÂΩï");
    } else {
      activities.data = response.data["Response"];
    }
  },
});

watch(
  store.profile,
  async () => {
    await activities.fetch();
  },
  { immediate: true, deep: true }
);

// Charts
const chart: any = reactive({
  id: "statistics-chart",
  chart: null,
  options: {
    tooltip: {
      trigger: "axis",
      axisPointer: {
        type: "cross",
        label: {
          backgroundColor: "#6a7985",
        },
      },
    },
    legend: {
      data: ["Ê∫ê‰ª£Á†Å", "Êé®ËçêÁ¨¶Êñá", "ÈÄªËæëÂ∏Å"],
    },
    toolbox: {
      feature: {
        saveAsImage: {},
      },
    },
    grid: {
      left: "3%",
      right: "4%",
      bottom: "3%",
      containLabel: true,
    },
    xAxis: [
      {
        type: "category",
        boundaryGap: false,
        data: ["Jan", "Feb", "Mar", "Apr", "May", "June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"],
      },
    ],
    yAxis: [
      {
        type: "value",
      },
    ],
    series: [
      {
        name: "Ê∫ê‰ª£Á†Å",
        type: "line",
        stack: "Total",
        areaStyle: {},
        emphasis: {
          focus: "series",
        },
        data: [120, 132, 101, 134, 90, 230, 210, 815, 145, 123, 224, 441],
      },
      {
        name: "Êé®ËçêÁ¨¶Êñá",
        type: "line",
        stack: "Total",
        areaStyle: {},
        emphasis: {
          focus: "series",
        },
        data: [220, 182, 191, 234, 991, 330, 415, 917, 57, 941, 294, 14],
      },
      {
        name: "ÈÄªËæëÂ∏Å",
        type: "line",
        stack: "Total",
        areaStyle: {},
        emphasis: {
          focus: "series",
        },
        data: [220, 182, 191, 234, 290, 330, 310, 14, 291, 144, 145, 1],
      },
    ],
  },
});

onMounted(() => {
  // @ts-ignore
  chart.chart = echarts.init(document.getElementById(chart.id), "light");
  chart.chart.setOption(chart.options);
});
</script>
